<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Educademy â€” Profile</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/Studentdashboard.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <button class="logo" onclick="location.href='/'" style="background:none;border:none;cursor:pointer;color:#2d7be5;font-size:1.7em;font-weight:bold;">
      Educademy
    </button>
    <nav class="nav-links">
      <a href="/" class="nav-link">Home</a>
      <a href="/#about" class="nav-link">About</a>
      <a href="/contact" class="nav-link">Contact</a>
      <button class="profile-btn" onclick="location.href='/profile'">ğŸ‘¤</button>
    </nav>
  </div>

  <!-- WELCOME SECTION -->
  <section class="welcome-section" aria-labelledby="welcome-heading">
    <div class="profile-wrapper">
      <img id="avatarImg" class="avatar" src="https://images.unsplash.com/photo-1583440194369-ac78b451536a?w=600" alt="Profile picture">
    </div>
    <h1 id="welcome-heading" class="welcome-title">Welcome back, {{ session.get('username', 'Student') }}!</h1>
    <p class="welcome-sub">Hereâ€™s a snapshot of your learning progress.</p>
  </section>

  <!-- MAIN CONTENT -->
  <main class="main" role="main">
    <section class="card">
      <h3>ğŸ“Š Learning Analytics</h3>
      <canvas id="quizTrend"></canvas>
    </section>

    <section class="card">
      <h3>ğŸ† Average Score By File</h3>
      <canvas id="scoreByFile"></canvas>
    </section>

    <section class="card">
      <h3>ğŸ“ Summary Types Used</h3>
      <canvas id="summaryByType"></canvas>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-grid">
      <div>
        <h4>Educademy</h4>
        <p style="color:var(--muted); margin:8px 0 0">
          Empowering learners worldwide with interactive quizzes and comprehensive tracking.
        </p>
      </div>
      <div>
        <h4>Quick Links</h4>
        <a href="/">Dashboard</a><a href="#">Courses</a><a href="/mcq">Quizzes</a><a href="/profile">Progress</a>
      </div>
      <div>
        <h4>Support</h4>
        <a href="#">Help Center</a><a href="/contact">Contact Us</a><a href="#">Privacy Policy</a><a href="#">Terms of Service</a>
      </div>
      <div>
        <h4>Connect</h4>
        <a href="#">GitHub</a><a href="#">Twitter</a><a href="#">LinkedIn</a><a href="mailto:adarsh.kushwaha_cs23@gla.ac.in">Email</a>
      </div>
    </div>
    <div class="copyright">&copy; 2025 Educademy. All rights reserved.</div>
  </footer>

  <!-- ğŸ”¥ FIXED JAVASCRIPT -->
  <script>
    const currentUser = "{{ session.get('username', '') }}";

    async function loadAnalytics(student) {
      try {
        const response = await fetch(`/analytics_summary/${student}`);
        const data = await response.json();

        if (data.error) return alert(data.error);

        // QUIZ TREND (LINE CHART)
        new Chart(document.getElementById("quizTrend"), {
          type: 'line',
          data: {
            labels: data.quiz_trend.map(q => new Date(q.date).toLocaleDateString()),
            datasets: [{
              label: 'Quiz %',
              data: data.quiz_trend.map(q => q.percentage),
              borderColor: '#2d7be5',
              backgroundColor: 'rgba(45,123,229,0.2)',
              fill: true
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
        });

        // â›” FIX: score_by_file MUST NOT be empty
        new Chart(document.getElementById("scoreByFile"), {
          type: 'bar',
          data: {
            labels: data.score_by_file.length ? data.score_by_file.map(s => s.file) : ['No Data'],
            datasets: [{
              label: 'Average %',
              data: data.score_by_file.length ? data.score_by_file.map(s => s.avg) : [0],
              backgroundColor: '#6ba8ff'
            }]
          },
          options: { responsive: true }
        });

        // SUMMARY TYPES - DONUT CHART
        new Chart(document.getElementById("summaryByType"), {
          type: 'doughnut',
          data: {
            labels: data.summary_types.length ? data.summary_types.map(s => s.type) : ['No Data'],
            datasets: [{
              data: data.summary_types.length ? data.summary_types.map(s => s.count) : [0],
              backgroundColor: ['#fbbf24', '#34d399', '#f87171', '#60a5fa']
            }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

      } catch (error) {
        console.error(error);
        alert("Error loading analytics.");
      }
    }

    if (currentUser) loadAnalytics(currentUser);
  </script>

</body>
</html>
