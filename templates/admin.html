<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduAcademy ‚Äî Admin Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* SAME THEME AS BEFORE ‚Äì NO CHANGES DONE */
    :root{
      --bg:#020617;--card:#0b1220;--glass-border:rgba(148,163,184,0.35);
      --muted:#9ca3af;--text:#e6eef8;--accent:#3b82f6;--accent-2:#60a5fa;
      --accent-3:#8b5cf6;--success:#10b981;--danger:#ef4444;
    }
    *,*::before,*::after{box-sizing:border-box;}
    body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:
      radial-gradient(circle at 0% 0%, rgba(56,189,248,0.06), transparent 45%),
      radial-gradient(circle at 100% 100%, rgba(139,92,246,0.04), transparent 45%),
      var(--bg);color:var(--text);min-height:100vh;}
    .navbar{position:sticky;top:0;display:flex;justify-content:space-between;
      padding:0.7em 3vw;background:rgba(2,6,23,0.86);border-bottom:1px solid rgba(255,255,255,0.03);}
    .logo{font-weight:700;font-size:1.7em;color:var(--accent-2);background:none;border:none;}
    .nav-links{display:flex;gap:1rem;}
    .nav-links a{color:var(--muted);text-decoration:none;}
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
      gap:20px;margin:22px auto;max-width:1100px;padding:0 1.2rem;}
    .chart-card{background:rgba(255,255,255,0.02);border-radius:12px;padding:18px;border:1px solid var(--glass-border);}
    table{width:100%;border-collapse:collapse;color:var(--text);}
    th,td{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.02);}
    footer {
  margin-top: 30px;
  padding: 28px 4vw;
  background: #020617;
  border-top: 1px solid rgba(148, 163, 184, 0.4);
  box-shadow: 0 -10px 40px rgba(15, 23, 42, 0.9);
}

.footer-grid {
  max-width: 1180px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
}

.footer-grid h4 {
  margin-bottom: 8px;
  color: var(--text-main);
}

footer p {
  color: var(--text-muted);
  margin: 8px 0 0;
}

.footer-grid a {
  color: var(--text-muted);
  text-decoration: none;
  display: block;
  margin: 4px 0;
  font-size: 0.94rem;
  transition: color 0.2s ease, transform 0.2s ease;
}

.footer-grid a:hover {
  color: var(--accent-soft);
  transform: translateX(2px);
}

.copyright {
  text-align: center;
  color: var(--text-muted);
  margin-top: 14px;
  font-size: 0.9rem;
}

  </style>
</head>

<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <button class="logo" onclick="location.href='/'">EduAcademy</button>
    <nav class="nav-links">
      <a href="/">Home</a>
      <a href="/logout">Logout</a>
    </nav>
  </div>

  <header style="text-align:center;padding:2rem 0;">
    <h1>üë®‚Äçüíº Admin Dashboard ‚Äî Student Analytics Overview</h1>
  </header>

  <!-- CHARTS -->
  <div class="charts">
    <div class="chart-card">
      <h3>üìà Average Quiz Scores per Student</h3>
      <canvas id="avgScoresChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>üìö Summary Submissions per Student</h3>
      <canvas id="summaryCountChart"></canvas>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-container" style="margin:auto;max-width:1100px;">
    <table id="studentTable">
      <thead>
        <tr>
          <th>Student</th>
          <th>File Name</th>
          <th>Score</th>
          <th>Total</th>
          <th>Percentage</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>
    <div class="footer-grid">
      <div>
        <h4>Educademy</h4>
        <p style="color:var(--muted); margin:8px 0 0">
          Empowering learners worldwide with interactive quizzes and comprehensive tracking.
        </p>
      </div>
      <div>
        <h4>Quick Links</h4>
        <a href="/">Dashboard</a><a href="#">Courses</a><a href="/mcq">Quizzes</a><a href="/profile">Progress</a>
      </div>
      <div>
        <h4>Support</h4>
        <a href="#">Help Center</a><a href="/contact">Contact Us</a><a href="#">Privacy Policy</a><a href="#">Terms of Service</a>
      </div>
      <div>
        <h4>Connect</h4>
        <a href="#">GitHub</a><a href="#">Twitter</a><a href="#">LinkedIn</a><a href="mailto:adarsh.kushwaha_cs23@gla.ac.in">Email</a>
      </div>
    </div>
    <div class="copyright">&copy; 2025 Educademy. All rights reserved.</div>
  </footer>

  <!-- ====================== FIXED JAVASCRIPT ====================== -->
  <script>
    async function loadAdminData() {
      try {
        // 1Ô∏è‚É£ Fetch quiz results
        const res = await fetch('/get_analytics_all');
        console.log("GET /get_analytics_all status:", res.status);
        if (!res.ok) throw new Error("API Failed: get_analytics_all");

        const data = await res.json();
        const tableBody = document.querySelector("#studentTable tbody");
        tableBody.innerHTML = "";

        const studentScores = {};
        data.forEach((r) => {
          tableBody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${r.student}</td>
              <td>${r.filename || 'N/A'}</td>
              <td>${r.score}</td>
              <td>${r.total}</td>
              <td>${r.percentage}%</td>
              <td>${new Date(r.timestamp).toLocaleString()}</td>
            </tr>`);

          if (!studentScores[r.student]) studentScores[r.student] = [];
          studentScores[r.student].push(r.percentage);
        });


        const avgLabels = Object.keys(studentScores);
        const avgData = avgLabels.map(name =>
          studentScores[name].reduce((a,b) => a + b, 0) / studentScores[name].length
        );

        new Chart(document.getElementById("avgScoresChart"), {
          type: "bar",
          data: { labels: avgLabels, datasets: [{ label: "Avg %", data: avgData }] },
          options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
        });


        const res2 = await fetch('/get_summary_counts');
        console.log("GET /get_summary_counts status:", res2.status);
        if (!res2.ok) throw new Error("API Failed: get_summary_counts");

        const sumData = await res2.json();
        const summaryCounts = {};
        sumData.forEach(s => summaryCounts[s.student] = s.count);

        new Chart(document.getElementById("summaryCountChart"), {
          type: "pie",
          data: {
            labels: Object.keys(summaryCounts),
            datasets: [{ data: Object.values(summaryCounts) }]
          },
          options: { responsive: true }
        });

      } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Error loading admin dashboard. Login as admin.");
      }
    }

    loadAdminData();
  </script>

</body>
</html>
